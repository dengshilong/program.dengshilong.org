title: 寻找更快的某数cookies生成方案
date: 2024-07-05 20:22:37
tags:
    - PM2
    - JavaScript
    - 补环境
categories:
---
未雨绸缪，虽然有了补环境通用方案，但为了应对可能更高的QPS需求，一直在想办法储备更快的cookies生成方案。简单计算下，假设需要400 QPS，而一般的补环境耗时250ms, 那么一个CPU一秒可以处理4个请求，400 QPS就需要100核CPU， 这对资源的消耗就很可观了。如果有个方案能50ms生成一个cookies, 那么就只需要20核CPU就能满足需求。

寻寻觅觅，在如画佬的星球里找到一个补环境方案，环境代码极少。示例代码是在Python中使用execjs来执行生成cookies, 改成Node服务后执行速度非常理想，能做到80ms生成一次。

美中不足的是需要在Node中使用eval执行js代码，会导致内存泄漏，这种内存泄漏使用强制内存回收也回收不了，最后程序会奔溃，用PM2限制内存使用和自动重启可以解决。但不可避免会出现502服务器错误，这在我们公司的生成环境中就不合适，因为运维一旦发现502超过一定数量就得让解决，得寻求其它方案。

要想又快又稳，想来只有算法方案了。
