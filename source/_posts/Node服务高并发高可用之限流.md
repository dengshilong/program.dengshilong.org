title: Node服务高并发高可用之限流
date: 2023-09-03 17:54:30
tags:
    - Node
    - 限流
    - 高可用
    - 高并发
categories:
---
在[Node服务高并发高可用之容器化与负载均衡](http://program.robinjia.cc/2023/09/02/Node%E6%9C%8D%E5%8A%A1%E9%AB%98%E5%B9%B6%E5%8F%91%E9%AB%98%E5%8F%AF%E7%94%A8%E4%B9%8B%E5%AE%B9%E5%99%A8%E5%8C%96%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/)中，我们已经解决了QPS如何满足用户需求的问题，这一篇我们再讲讲限流，以及如何使用限流来提高我们服务的可用性。在[使用node-rate-limiter-flexible服务限流](http://program.robinjia.cc/2022/11/19/%E4%BD%BF%E7%94%A8node-rate-limiter-flexible%E6%9C%8D%E5%8A%A1%E9%99%90%E6%B5%81/)中，已经提过一次限流，这里我们继续说一说。

限流有很多用途，比如很多道友会提供接口给人用，为了限制对方调用的调用频率，此时就可以加上限流功能。

比如有个网站每秒只支持100个人访问，结果有同时有10000个人去访问，如果没有限流，可能网站就会奔溃了。

比如一个接口每秒只能支持10QPS, 但调用方因为突发流量，每秒调用100次，那这时候第10次～20次请求就要1～2秒才响应，第20～30次请求就要2～3秒才响应，第90～100次请求就要9～10秒才响应，导致接口超时严重，运维就会找过来了。

如果加上限流功能，这上面的问题就都解决了。当访问数量超过支持的数量时，就直接告诉对方，你被限流了，这样能保证自己的服务不会奔溃。

Node里有很多限流模块，我这里使用node-rate-limiter-flexible，它不需要引入额外模块如Redis等做限流，只是在每个Node进程里做限流，满足我的需求。一个简单的配置如下

```
const burstyLimiter = new BurstyRateLimiter(
  new RateLimiterMemory({
    points: 3,
    duration: 1,
  }),
  new RateLimiterMemory({
    keyPrefix: 'burst',
    points: 5,
    duration: 5,
  })
);
```

它是用了两个限流配置，第一个的令牌用完了，就会去用第二个的。如下就是一个QPS是4，支持突发流量到8的配置，相当好用。第一个配置每一秒生成3个令牌，第二个配置每5秒生成5个令牌，那么5秒内就一共可以生成3 * 5 + 5 = 20个令牌，相当于这5秒内的QPS是4，而它的突发流量是8，也就是第一秒内如果进来8个请求，它也不会触发限流。

在服务高可用方面，除了限流，还有熔断，服务降级，我也只听过，没用过。我这里只使用限流功能就够了，其它就不管了。
